library(readxl)
library(ggplot2)
library(dplyr)
library(tidyr)
library(rJava)
library(XLConnect)

#Must change 'setwd()' and 'path()' to the directory where all spreadsheets output by SpinalMod are located. This script will check all files and folders within the working directory.
setwd("E:/Data/Cord_Prep_New/")
path <- "E:/Data/Cord_Prep_New/"
pattern1 = c(".xls", ".xlsx")
files <- dir(path, recursive = TRUE, full.names = TRUE, pattern = pattern1)
#Create combined table with all raw burst data from all spreadsheets 
files_ind <- lapply(
  files, function(x) {
    wb <- loadWorkbook(x)
    if(existsSheet(wb, "Individual_Bursts")){
      read_excel(x, sheet =  "Individual_Bursts") %>%
        mutate(File = x)}})
newfiles <- lengths(files_ind) ==  13
combined_ind <- do.call("rbind", lapply(files_ind[newfiles ==  TRUE], as.data.frame))

combined_ind$File = substr(combined_ind$File, 23,48)
histo <- na.omit(combined_ind) %>%
  mutate(Drug =  case_when(
    File == "/01_31_22/22131012.abf.xls" ~ "None", 
    File == "/01_31_22/22131013.abf.xls" ~ "None", 
    File == "/01_31_22/22131014.abf.xls" ~ "None", 
    File ==  "/01_31_22/22131020.abf.xls" ~ "4-AP",
    File ==  "/01_31_22/22131021.abf.xls" ~ "4-AP",
    File ==  "/01_31_22/22131022.abf.xls" ~ "4-AP",
    File ==  "/01_31_22/22131027.abf.xls" ~ "Picrotoxin",
    File ==  "/01_31_22/22131028.abf.xls" ~ "Picrotoxin",
    File == "/02_01_22/22201002.abf.xls" ~ "None",
    File ==  "/02_01_22/22201017.abf.xls" ~ "VU0240551",
    File ==  "/02_01_22/22201024.abf.xls" ~ "VU0240551",
    File ==  "/02_01_22/22201029.abf.xls" ~ "Picrotoxin",
    File ==  "/02_03_22/22203002.abf.xls" ~ "None",
    File ==  "/02_03_22/22203010.abf.xls" ~ "4-AP", 
    File ==  "/02_03_22/22203020.abf.xls" ~ "Picrotoxin",
    File == "/03_24_22/22324036.abf.xls" ~ "4-AP", 
    File ==  "/06_02_22/22602017.abf.xls" ~ "None",
    File ==  "/06_02_22/22602019.abf.xls" ~ "None",
    File ==  "/06_02_22/22602024.abf.xls" ~ "VU0240551",
    File ==  "/06_02_22/22602035.abf.xls" ~ "Picrotoxin",
    File ==  "/06_06_22/22606005.abf.xls" ~ "None",
    File ==  "/06_06_22/22606011.abf.xls" ~ "None",
    File ==  "/06_06_22/22606022.abf.xls" ~ "VU0463271",
    File ==  "/06_06_22/22606023.abf.xls" ~ "VU0463271",
    File ==  "/06_06_22/22606026.abf.xls" ~ "Picrotoxin",
    File ==  "/06_08_22/22608008.abf.xls" ~ "None",
    File ==  "/06_08_22/22608023.abf.xls" ~ "VU0463271",
    File ==  "/06_08_22/22608032.abf.xls" ~ "4-AP",
    File ==  "/06_08_22/22608036.abf.xls" ~ "Retigabine",
    File ==  "/06_08_22/22608039.abf.xls" ~ "Bicuculline",
    File ==  "/09_07_21/21907008.abf.xls" ~ "None",
    File ==  "/09_07_21/21907034.abf.xls" ~ "None",
    File ==  "/09_07_21/21907052.abf.xls" ~ "VU0240551",
    File ==  "/09_07_21/21907065.abf.xls" ~ "VU0240551",
    File ==  "/07_29_21/21729016.abf.xls" ~ "VU0240551",
    File ==  "/07_29_21/21729033.abf.xls" ~ "4-AP",
    File ==  "/07_27_21/21727013.abf.xls" ~ "None",
    File ==  "/07_27_21/21727021.abf.xls" ~ "4-AP",
    File ==  "/07_22_21/21722021.abf.xls" ~ "None",
    File ==  "/07_22_21/21722032.abf.xls" ~ "4-AP",
    File ==  "/07_22_21/21722035.abf.xls" ~ "4-AP",
    File ==  "/07_22_21/21722044.abf.xls" ~ "Retigabine",
    File ==  "/07_22_21/21722045.abf.xls" ~ "Retigabine",
    File ==  "/07_22_21/21722064.abf.xls" ~ "Picrotoxin",
    File ==  "/07_19_21/21719021.abf.xls" ~ "None",
    File ==  "/07_19_21/21719022.abf.xls" ~ "None",
    File ==  "/07_16_21/21716014.abf.xls" ~ "None",
    File ==  "/07_16_21/21716037.abf.xls" ~ "None",
    File ==  "/07_16_21/21716039.abf.xls" ~ "None",
    File ==  "/07_16_21/21716044.abf.xls" ~ "4-AP",
    File ==  "/07_16_21/21716045.abf.xls" ~ "4-AP",
    File ==  "/07_16_21/21716056.abf.xls" ~ "Gabazine",
    File ==  "/07_16_21/21716057.abf.xls" ~ "Gabazine",
    File ==  "/07_08_21/21708031.abf.xls" ~ "None",
    File ==  "/07_08_21/21708048.abf.xls" ~ "4-AP",
    File ==  "/07_08_21/21708051.abf.xls" ~ "Picrotoxin",
    File ==  "/06_25_21/21625033.abf.xls" ~ "None",
    File ==  "/06_25_21/21625043.abf.xls" ~ "4-AP",
    File ==  "/06_25_21/21625049.abf.xls" ~ "Bicuculline",
    File ==  "/06_24_21/21624008.abf.xls" ~ "None",
    File ==  "/06_24_21/21624063.abf.xls"  ~ "None",
    File ==  "/06_24_21/21624050.abf.xls" ~ "4-AP",
    File ==  "/06_24_21/21624063.abf.xls" ~ "Bicuculline",
    File ==  "/06_18_21/21618036.abf.xls" ~ "None",
    File ==  "/06_18_21/21618038.abf.xls" ~ "None",
    File ==  "/06_18_21/21618047.abf.xls" ~ "4-AP",
    File ==  "/06_18_21/21618052.abf.xls" ~ "4-AP",
    File ==  "/06_18_21/21618061.abf.xls" ~ "Bicuculline",
    File ==  "/06_17_21/21617018.abf.xls" ~ "None",
    File ==  "/06_17_21/21617032.abf.xls" ~ "None",
    File ==  "/06_17_21/21617036.abf.xls" ~ "Bicuculline",
    File ==  "/06_11_21/21611023.abf.xls" ~ "None",
    File ==  "/06_11_21/21611024.abf.xls" ~ "None",
    File ==  "/06_11_21/21611028.abf.xls" ~ "None",
    File ==  "/06_11_21/21611041.abf.xls" ~ "None",
    File ==  "/06_11_21/21611056.abf.xls" ~ "Bicuculline",)) 
histo <- histo %>%
      filter(Channel != 0)
histo <- histo %>%
  mutate(Level =  case_when(
    File == "/01_31_22/22131012.abf.xls" &  Channel == 1 ~ "Rt T12", 
    File == "/01_31_22/22131012.abf.xls" &  Channel == 2 ~ "Rt L1", 
    File == "/01_31_22/22131013.abf.xls" &  Channel == 1 ~ "Rt T12", 
    File == "/01_31_22/22131013.abf.xls" &  Channel == 2 ~ "Rt L1", 
    #File == "/01_31_22/22131013.abf.xls" &  Channel == 3 ~ "Rt T10", 
    File == "/01_31_22/22131014.abf.xls" &  Channel == 1 ~ "Rt T12", 
    File == "/01_31_22/22131014.abf.xls" &  Channel == 2 ~ "Rt L1", 
    #File == "/01_31_22/22131014.abf.xls" &  Channel == 3 ~ "Rt T10",
    File == "/01_31_22/22131020.abf.xls" &  Channel == 1 ~ "Rt T12",
    File == "/01_31_22/22131020.abf.xls" &  Channel == 2 ~ "Rt L1", 
    File == "/01_31_22/22131021.abf.xls" &  Channel == 1 ~ "Rt T12",
    File == "/01_31_22/22131021.abf.xls" &  Channel == 2 ~ "Rt L1", 
    File == "/01_31_22/22131022.abf.xls" &  Channel == 1 ~ "Rt T12",
    File == "/01_31_22/22131022.abf.xls" &  Channel == 2 ~ "Rt L1", 
    #File == "/01_31_22/22131022.abf.xls" &  Channel == 3 ~ "Rt T10",
    File == "/01_31_22/22131027.abf.xls" &  Channel == 1 ~ "Rt T12",
    File == "/01_31_22/22131027.abf.xls" &  Channel == 2 ~ "Rt L1",
    File == "/01_31_22/22131028.abf.xls" &  Channel == 1 ~ "Rt T12",
    File == "/01_31_22/22131028.abf.xls" &  Channel == 2 ~ "Rt L1",
    File == "/02_01_22/22201002.abf.xls" & Channel == 1 ~ "Rt T11", 
    File ==  "/02_01_22/22201002.abf.xls" & Channel == 2 ~ "Lft T13",
    #File ==  "/02_01_22/22201017.abf.xls"  & Channel == 1 ~ "Lft T12",
    File ==  "/02_01_22/22201017.abf.xls"  & Channel == 2 ~ "Rt T11",
    File ==  "/02_01_22/22201017.abf.xls"  & Channel == 3 ~ "Lft T13",
    File ==  "/02_01_22/22201024.abf.xls"  & Channel == 1 ~ "Rt L3",
    File ==  "/02_01_22/22201024.abf.xls"  & Channel == 2 ~ "Lft T12",
    File ==  "/02_01_22/22201024.abf.xls"  & Channel == 3 ~ "Rt T11",
    File ==  "/02_01_22/22201024.abf.xls"  & Channel == 4 ~ "Lft L2",
    File ==  "/02_01_22/22201024.abf.xls"  & Channel == 5 ~ "Lft T13",
    File ==  "/02_01_22/22201029.abf.xls"  & Channel == 1 ~ "Rt T11",
    File ==  "/02_01_22/22201029.abf.xls"  & Channel == 2 ~ "Lft T13",
    File ==  "/02_03_22/22203002.abf.xls" & Channel == 1 ~ "Rt L4", 
    File ==  "/02_03_22/22203002.abf.xls" & Channel == 2 ~ "Rt L3",
    File ==  "/02_03_22/22203002.abf.xls" & Channel == 3 ~ "Rt L3",
    File ==  "/02_03_22/22203002.abf.xls" & Channel == 4 ~ "Lft L3",
    File ==  "/02_03_22/22203010.abf.xls" & Channel == 1 ~ "Rt L4", 
    File ==  "/02_03_22/22203010.abf.xls" & Channel == 2 ~ "Rt L3",
    File ==  "/02_03_22/22203010.abf.xls" & Channel == 3 ~ "Rt L3",
    File ==  "/02_03_22/22203010.abf.xls" & Channel == 4 ~ "Lft L4",
    File ==  "/02_03_22/22203020.abf.xls" & Channel == 1 ~ "Rt L4", 
    File ==  "/02_03_22/22203020.abf.xls" & Channel == 2 ~ "Rt L3",
    File ==  "/02_03_22/22203020.abf.xls" & Channel == 3 ~ "Rt L3",
    File ==  "/02_03_22/22203020.abf.xls" & Channel == 4 ~ "Lft L4",
    File  ==  "/03_24_22/22324036.abf.xls" &  Channel == 1 ~ "Lft T11",
    File ==  "/06_02_22/22602017.abf.xls" & Channel == 1 ~ "Rt T13",
    File ==  "/06_02_22/22602017.abf.xls" & Channel == 2 ~ "Lft T13",
    File ==  "/06_02_22/22602017.abf.xls" & Channel == 3 ~ "Rt T12",
    File ==  "/06_02_22/22602019.abf.xls" & Channel == 1 ~ "Lft T13",
    File ==  "/06_02_22/22602019.abf.xls" & Channel == 2 ~ "Lft T12",
    File ==  "/06_02_22/22602024.abf.xls" & Channel == 1 ~ "Lft T13",
    File ==  "/06_02_22/22602024.abf.xls" & Channel == 2 ~ "Lft T12",
    File ==  "/06_02_22/22602035.abf.xls" & Channel == 1 ~ "Lft T13",
    File ==  "/06_02_22/22602035.abf.xls" & Channel == 2 ~ "Lft T12",
    File ==  "/06_06_22/22606005.abf.xls" & Channel == 1 ~ "Rt T12",
    File ==  "/06_06_22/22606011.abf.xls" & Channel == 1 ~ "Rt L1",
    #File ==  "/06_06_22/22606011.abf.xls" & Channel == 2 ~ "Lft L2", 
    File ==  "/06_06_22/22606011.abf.xls" & Channel == 3 ~ "Lft L1", 
    File ==  "/06_06_22/22606011.abf.xls" & Channel == 4 ~ "Rt T13",
    File ==  "/06_06_22/22606022.abf.xls" & Channel == 1 ~ "Rt L1",
    #File ==  "/06_06_22/22606022.abf.xls" & Channel == 2 ~ "Lft L2", 
    File ==  "/06_06_22/22606022.abf.xls" & Channel == 3 ~ "Lft L1", 
    File ==  "/06_06_22/22606022.abf.xls" & Channel == 4 ~ "Rt T13",
    File ==  "/06_06_22/22606023.abf.xls" & Channel == 1 ~ "Rt L1",
    #File ==  "/06_06_22/22606023.abf.xls" & Channel == 2 ~ "Lft L2", 
    File ==  "/06_06_22/22606023.abf.xls" & Channel == 3 ~ "Lft L1", 
    File ==  "/06_06_22/22606023.abf.xls" & Channel == 4 ~ "Rt T13",
    File ==  "/06_06_22/22606026.abf.xls" & Channel == 1 ~ "Rt L1",
    #File ==  "/06_06_22/22606026.abf.xls" & Channel == 2 ~ "Lft L2", 
    File ==  "/06_06_22/22606026.abf.xls" & Channel == 3 ~ "Lft L1", 
    File ==  "/06_06_22/22606026.abf.xls" & Channel == 4 ~ "Rt T13",
    File ==  "/06_08_22/22608008.abf.xls"& Channel == 1 ~ "Rt  T13",
    File ==  "/06_08_22/22608008.abf.xls"& Channel == 2 ~ "Lft T12",
    File ==  "/06_08_22/22608008.abf.xls"& Channel == 3 ~ "Lft L1",
    File ==  "/06_08_22/22608008.abf.xls"& Channel == 4 ~ "Rt T11",
    File ==  "/06_08_22/22608023.abf.xls"& Channel == 1 ~ "Rt  T13",
    File ==  "/06_08_22/22608023.abf.xls"& Channel == 2 ~ "Lft T12",
    File ==  "/06_08_22/22608023.abf.xls"& Channel == 3 ~ "Lft L1",
    File ==  "/06_08_22/22608023.abf.xls"& Channel == 4 ~ "Rt T11",
    File ==  "/06_08_22/22608032.abf.xls"& Channel == 1 ~ "Rt  T13",
    File ==  "/06_08_22/22608032.abf.xls"& Channel == 2 ~ "Lft T12",
    File ==  "/06_08_22/22608032.abf.xls"& Channel == 3 ~ "Lft L1",
    File ==  "/06_08_22/22608032.abf.xls"& Channel == 4 ~ "Rt T11",
    File ==  "/06_08_22/22608036.abf.xls"& Channel == 1 ~ "Rt  T13",
    File ==  "/06_08_22/22608036.abf.xls"& Channel == 2 ~ "Lft T12",
    File ==  "/06_08_22/22608036.abf.xls"& Channel == 3 ~ "Lft L1",
    File ==  "/06_08_22/22608036.abf.xls"& Channel == 4 ~ "Rt T11",
    File ==  "/06_08_22/22608039.abf.xls"& Channel == 1 ~ "Rt  T13",
    File ==  "/06_08_22/22608039.abf.xls"& Channel == 2 ~ "Lft T12",
    File ==  "/06_08_22/22608039.abf.xls"& Channel == 3 ~ "Lft L1",
    File ==  "/06_08_22/22608039.abf.xls"& Channel == 4 ~ "Rt T11",
    File == "/03_24_22/22324036.abf.xls" & Channel == 3 ~ "Lft L3", 
    File == "/09_07_21/21907008.abf.xls" &  Channel == 1 ~ "Lft  L2",
    File == "/09_07_21/21907008.abf.xls" &  Channel == 3 ~ "Lft  L3",
    File == "/09_07_21/21907008.abf.xls" &  Channel == 5 ~ "Rt  L2",
    File == "/09_07_21/21907034.abf.xls" &  Channel == 1 ~ "Rt L4",
    File == "/09_07_21/21907034.abf.xls" &  Channel == 3 ~ "Rt L3",
    File == "/09_07_21/21907034.abf.xls" &  Channel == 5 ~ "Rt L2",
    File == "/09_07_21/21907052.abf.xls" &  Channel == 1 ~ "Rt L2",
    File == "/09_07_21/21907052.abf.xls" &  Channel == 3 ~ "Rt T11",
    File == "/09_07_21/21907052.abf.xls" &  Channel == 5 ~ "Rt T12",
    File == "/07_29_21/21729016.abf.xls" &  Channel == 1 ~ "Rt  L1",
    File == "/07_29_21/21729016.abf.xls" &  Channel == 2 ~ "Rt  L1",
    File == "/07_29_21/21729016.abf.xls" &  Channel == 3 ~ "Lft  L1",
    File == "/07_29_21/21729016.abf.xls" &  Channel == 4 ~ "Lft  L1",
    File ==  "/07_29_21/21729033.abf.xls"  & Channel == 1 ~ "Rt L1",
    File ==  "/07_29_21/21729033.abf.xls"  & Channel == 3 ~ "Rt L1",
    File ==  "/07_29_21/21729033.abf.xls"  & Channel == 4 ~ "Lft L1",
    File ==  "/07_27_21/21727013.abf.xls"  & Channel == 1 ~ "Lft L3",
    File ==  "/07_27_21/21727013.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_27_21/21727021.abf.xls"  & Channel == 1 ~ "Lft L1",
    File ==  "/07_27_21/21727021.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_22_21/21722024.abf.xls"  & Channel == 1 ~ "Rt T12",
    File ==  "/07_22_21/21722024.abf.xls"  & Channel == 2 ~ "Lft T11",
    File ==  "/07_22_21/21722024.abf.xls"  & Channel == 3 ~ "Rt T11",
    File ==  "/07_22_21/21722024.abf.xls"  & Channel == 4 ~ "Rt L2",
    File ==  "/07_22_21/21722032.abf.xls"  & Channel == 1 ~ "Lft L2",
    File ==  "/07_22_21/21722032.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_22_21/21722032.abf.xls"  & Channel == 4 ~ "Rt L2",
    File ==  "/07_22_21/21722035.abf.xls"  & Channel == 1 ~ "Lft L2",
    File ==  "/07_22_21/21722035.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_22_21/21722035.abf.xls"  & Channel == 4 ~ "Rt L2",
    File ==  "/07_22_21/21722044.abf.xls"  & Channel == 1 ~ "Lft L2",
    File ==  "/07_22_21/21722044.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_22_21/21722044.abf.xls"  & Channel == 3 ~ "Lft T10",
    File ==  "/07_22_21/21722044.abf.xls"  & Channel == 4 ~ "Rt L2",
    File ==  "/07_22_21/21722045.abf.xls"  & Channel == 1 ~ "Lft L2",
    File ==  "/07_22_21/21722045.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_22_21/21722045.abf.xls"  & Channel == 3 ~ "Lft T10",
    File ==  "/07_22_21/21722045.abf.xls"  & Channel == 4 ~ "Rt L2",
    File ==  "/07_22_21/21722064.abf.xls"  & Channel == 1 ~ "Lft L2",
    File ==  "/07_22_21/21722064.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_22_21/21722064.abf.xls"  & Channel == 3 ~ "Lft T10",
    File ==  "/07_22_21/21722064.abf.xls"  & Channel == 4 ~ "Rt L2",
    File ==  "/07_19_21/21719021.abf.xls"  & Channel == 1 ~ "Lft L2",
    File ==  "/07_19_21/21719022.abf.xls"  & Channel == 1 ~ "Lft L2",
    File ==  "/07_16_21/21716014.abf.xls"  & Channel == 3 ~ "Rt L2",
    File ==  "/07_16_21/21716037.abf.xls"  & Channel == 1 ~ "Lft L4",
    File ==  "/07_16_21/21716037.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_16_21/21716037.abf.xls"  & Channel == 3 ~ "Rt L3",
    File ==  "/07_16_21/21716039.abf.xls"  & Channel == 1 ~ "Lft L4",
    File ==  "/07_16_21/21716039.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_16_21/21716039.abf.xls"  & Channel == 3 ~ "Rt L3",
    File ==  "/07_16_21/21716044.abf.xls"  & Channel == 1 ~ "Lft L4",
    File ==  "/07_16_21/21716044.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_16_21/21716044.abf.xls"  & Channel == 3 ~ "Rt L3",
    File ==  "/07_16_21/21716045.abf.xls"  & Channel == 1 ~ "Lft L4",
    File ==  "/07_16_21/21716045.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_16_21/21716045.abf.xls"  & Channel == 3 ~ "Rt L3",
    File ==  "/07_16_21/21716056.abf.xls"  & Channel == 1 ~ "Lft L4",
    File ==  "/07_16_21/21716056.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_16_21/21716056.abf.xls"  & Channel == 3 ~ "Rt L3",
    File ==  "/07_16_21/21716057.abf.xls"  & Channel == 1 ~ "Lft L4",
    File ==  "/07_16_21/21716057.abf.xls"  & Channel == 2 ~ "Lft L2",
    File ==  "/07_16_21/21716057.abf.xls"  & Channel == 3 ~ "Rt L3",
    File ==  "/07_08_21/21708031.abf.xls" &  Channel == 1 ~ "Rt L2",
    File ==  "/07_08_21/21708031.abf.xls" &  Channel == 2 ~ "Rt L3",
    File ==  "/07_08_21/21708031.abf.xls" &  Channel == 3 ~ "Rt T12",
    File ==  "/07_08_21/21708031.abf.xls" &  Channel == 4 ~ "Rt L1",
    File ==  "/07_08_21/21708048.abf.xls" &  Channel == 1 ~ "Lft L2",
    File ==  "/07_08_21/21708051.abf.xls" &  Channel == 1 ~ "Lft L2",
    File ==  "/06_25_21/21625033.abf.xls" &  Channel == 1 ~ "Rt L3",
    File ==  "/06_25_21/21625033.abf.xls" &  Channel == 2 ~ "Rt L2",
    File ==  "/06_25_21/21625033.abf.xls" &  Channel == 4 ~ "Rt L2",
    File ==  "/06_25_21/21625043.abf.xls" &  Channel == 1 ~ "Rt L3",
    File ==  "/06_25_21/21625043.abf.xls" &  Channel == 2 ~ "Rt L2",
    File ==  "/06_25_21/21625043.abf.xls" &  Channel == 4 ~ "Rt L2",
    File ==  "/06_25_21/21625049.abf.xls" &  Channel == 1 ~ "Rt L3",
    File ==  "/06_25_21/21625049.abf.xls" &  Channel == 2 ~ "Rt L2",
    File ==  "/06_25_21/21625049.abf.xls" &  Channel == 4 ~ "Rt L2",
    File ==  "/06_24_21/21624008.abf.xls" &  Channel  ==  1 ~ "Lft T13",
    File ==  "/06_24_21/21624008.abf.xls" &  Channel  ==  3 ~ "Rt L4",
    File ==  "/06_24_21/21624046.abf.xls" &  Channel  ==  2 ~ "Lft T13",
    File ==  "/06_24_21/21624050.abf.xls" &  Channel  ==  2 ~ "Lft T13",
    File ==  "/06_24_21/21624063.abf.xls" &  Channel  ==  2 ~ "Lft T13",
    File ==  "/06_18_21/21618036.abf.xls" &  Channel  ==  1 ~ "Lft L2",
    File ==  "/06_18_21/21618036.abf.xls" &  Channel  ==  2 ~ "Lft L1",
    File ==  "/06_18_21/21618038.abf.xls" &  Channel  ==  1 ~ "Lft L2",
    File ==  "/06_18_21/21618038.abf.xls" &  Channel  ==  2 ~ "Lft L1",
    File ==  "/06_18_21/21618047.abf.xls" &  Channel  ==  1 ~ "Lft L2",
    File ==  "/06_18_21/21618047.abf.xls" &  Channel  ==  2 ~ "Lft L1",
    File ==  "/06_18_21/21618052.abf.xls" &  Channel  ==  1 ~ "Lft L2",
    File ==  "/06_18_21/21618061.abf.xls" &  Channel  ==  1 ~ "Lft L2",
    File ==  "/06_18_21/21618061.abf.xls" &  Channel  ==  2 ~ "Lft L1",
    File ==  "/06_17_21/21617018.abf.xls" &  Channel  ==  1 ~ "Rt L3",
    File ==  "/06_17_21/21617018.abf.xls" &  Channel  ==  2 ~ "Rt L4",
    File ==  "/06_17_21/21617018.abf.xls" &  Channel  ==  3 ~ "Lft L3",
    File ==  "/06_17_21/21617032.abf.xls" &  Channel  ==  1 ~ "Rt S1",
    File ==  "/06_17_21/21617032.abf.xls" &  Channel  ==  2 ~ "Lft S1",
    File ==  "/06_17_21/21617032.abf.xls" &  Channel  ==  4 ~ "Lft L1",
    File ==  "/06_17_21/21617036.abf.xls" &  Channel  ==  1 ~ "Rt S1",
    File ==  "/06_17_21/21617036.abf.xls" &  Channel  ==  2 ~ "Lft S1",
    File ==  "/06_11_21/21611023.abf.xls" &  Channel  ==  1 ~ "Lft T10",
    File ==  "/06_11_21/21611023.abf.xls" &  Channel  ==  2 ~ "Lft T13",
    File ==  "/06_11_21/21611023.abf.xls" &  Channel  ==  3 ~ "Rt L2",
    File ==  "/06_11_21/21611024.abf.xls" &  Channel  ==  1 ~ "Lft T10",
    File ==  "/06_11_21/21611024.abf.xls" &  Channel  ==  2 ~ "Lft T13",
    File ==  "/06_11_21/21611024.abf.xls" &  Channel  ==  3 ~ "Rt L2",
    File ==  "/06_11_21/21611028.abf.xls" &  Channel  ==  1 ~ "Lft T8",
    File ==  "/06_11_21/21611028.abf.xls" &  Channel  ==  2 ~ "Lft T9",
    File ==  "/06_11_21/21611028.abf.xls" &  Channel  ==  3 ~ "Rt T9",
    File ==  "/06_11_21/21611041.abf.xls" &  Channel  ==  1 ~ "Lft L1",
    File ==  "/06_11_21/21611041.abf.xls" &  Channel  ==  2 ~ "Lft L2",
    File ==  "/06_11_21/21611041.abf.xls" &  Channel  ==  3 ~ "Rt L2",
    File ==  "/06_11_21/21611056.abf.xls" &  Channel  ==  1 ~ "Lft L1",
    File ==  "/06_11_21/21611056.abf.xls" &  Channel  ==  2 ~ "Lft L2",
    File ==  "/06_11_21/21611056.abf.xls" &  Channel  ==  3 ~ "Rt L2",
)) %>%
  mutate(LevelCode =  case_when(
    grepl("T6", Level) == TRUE ~ 6,
    grepl("T7", Level) == TRUE ~ 7,
    grepl("T8", Level) == TRUE ~ 8,
    grepl("T9", Level) == TRUE ~ 9,
    grepl("T10", Level) == TRUE ~ 10,
    grepl("T11", Level) == TRUE ~ 11,
    grepl("T12", Level) == TRUE ~ 12,
    grepl("T13", Level) == TRUE ~ 13,
    grepl("L1", Level) == TRUE ~ 14,
    grepl("L2", Level) == TRUE ~ 15,
    grepl("L3", Level) == TRUE ~ 16,
    grepl("L4", Level) == TRUE ~ 17,
    grepl("L5", Level) == TRUE ~ 18,
    grepl("S1", Level) == TRUE ~ 19,)) %>%
  mutate(RecSideCode = case_when(
    grepl("Rt", Level) ~ "R", 
    grepl("Lft", Level) ~ "L")) %>%
  mutate(StimLevel =  case_when(
    File == "/01_31_22/22131012.abf.xls" ~ "Rt L1",
    File == "/01_31_22/22131013.abf.xls" ~ "Rt L1",  
    File == "/01_31_22/22131014.abf.xls" ~ "Rt L1", 
    File == "/01_31_22/22131020.abf.xls" ~ "Rt L1",
    File == "/01_31_22/22131021.abf.xls" ~ "Rt L1",
    File == "/01_31_22/22131022.abf.xls" ~ "Rt L1",
    File == "/01_31_22/22131027.abf.xls" ~ "Rt L1",
    File == "/01_31_22/22131028.abf.xls" ~ "Rt L1",
    File ==  "/02_01_22/22201002.abf.xls" ~ "Rt T12",
    File ==  "/02_01_22/22201017.abf.xls" ~ "Rt T12",
    File ==  "/02_01_22/22201024.abf.xls" ~ "Rt T12",
    File ==  "/02_01_22/22201029.abf.xls" ~ "Rt T12",
    File ==  "/02_03_22/22203002.abf.xls" ~ "Rt L3",
    File ==  "/02_03_22/22203010.abf.xls" ~ "Rt L3", 
    File ==  "/02_03_22/22203020.abf.xls" ~ "Rt L3",
    File == "/03_24_22/22324036.abf.xls" ~ "Rt L3",
    File ==  "/06_02_22/22602017.abf.xls" ~ "Lft L2",
    File ==  "/06_02_22/22602019.abf.xls" ~ "Lft L2",
    File ==  "/06_02_22/22602022.abf.xls" ~ "Lft L2",
    File ==  "/06_02_22/22602023.abf.xls" ~ "Lft L2",
    File ==  "/06_02_22/22602024.abf.xls" ~ "Lft L2",
    File ==  "/06_02_22/22602035.abf.xls" ~ "Lft L2",
    File ==  "/06_06_22/22606005.abf.xls" ~ "Lft T11",
    File ==  "/06_06_22/22606011.abf.xls" ~ "Lft L2",
    File ==  "/06_06_22/22606022.abf.xls" ~ "Lft L2",
    File ==  "/06_06_22/22606023.abf.xls" ~ "Lft L2",
    File ==  "/06_06_22/22606026.abf.xls" ~ "Lft L2",
    File ==  "/06_08_22/22608008.abf.xls" ~ "Rt  T13",
    File ==  "/06_08_22/22608023.abf.xls" ~ "Rt  T13",
    File ==  "/06_08_22/22608032.abf.xls" ~ "Rt  T13",
    File ==  "/06_08_22/22608036.abf.xls" ~ "Rt  T13",
    File ==  "/06_08_22/22608039.abf.xls" ~ "Rt  T13",
    File == "/09_07_21/21907008.abf.xls" ~ "Lft  L2",
    File == "/09_07_21/21907034.abf.xls" ~ "Lft  L4",
    File == "/09_07_21/21907052.abf.xls" ~ "Lft  T12",
    File == "/07_29_21/21907016.abf.xls" ~ "Lft  T13",
    File ==  "/07_29_21/21729033.abf.xls" ~ "Rt L1",
    File ==  "/07_27_21/21727013.abf.xls" ~ "Lft L2",
    File ==  "/07_27_21/21727021.abf.xls" ~ "Lft L2",
    File ==  "/07_22_21/21722024.abf.xls" ~ "Rt T12",
    File ==  "/07_22_21/21722032.abf.xls" ~ "Rt T12",
    File ==  "/07_22_21/21722035.abf.xls" ~ "Rt T12",
    File ==  "/07_22_21/21722044.abf.xls" ~ "Rt T12",
    File ==  "/07_22_21/21722045.abf.xls" ~ "Rt T12",
    File ==  "/07_22_21/21722064.abf.xls" ~ "Rt T12",
    File ==  "/07_19_21/21719021.abf.xls" ~ "Lft L2",
    File ==  "/07_19_21/21719022.abf.xls"  ~ "Lft L2",
    File ==  "/07_16_21/21716014.abf.xls" ~ "Lft L4",
    File ==  "/07_16_21/21716037.abf.xls" ~ "Lft L3",
    File ==  "/07_16_21/21716039.abf.xls" ~ "Lft L3",
    File ==  "/07_16_21/21716044.abf.xls" ~ "Lft L3",
    File ==  "/07_16_21/21716045.abf.xls" ~ "Lft L3",
    File ==  "/07_16_21/21716056.abf.xls" ~ "Lft L3",
    File ==  "/07_16_21/21716057.abf.xls" ~ "Lft L3",
    File ==  "/07_08_21/21708031.abf.xls" ~ "Rt L1",
    File ==  "/07_08_21/21708048.abf.xls" ~ "Rt L3",
    File ==  "/07_08_21/21708051.abf.xls" ~ "Rt L3",
    File ==  "/06_25_21/21625033.abf.xls"  ~ "Rt L3",
    File ==  "/06_25_21/21625043.abf.xls"  ~ "Rt L3",
    File ==  "/06_25_21/21625049.abf.xls"  ~ "Rt L3",
    File ==  "/06_24_21/21624008.abf.xls" ~ "Lft L4",
    File ==  "/06_24_21/21624050.abf.xls" ~ "Rt L3",
    File ==  "/06_24_21/21624063.abf.xls" ~ "Rt L3",
    File ==  "/06_18_21/21618036.abf.xls"  ~ "Lft T12",
    File ==  "/06_18_21/21618038.abf.xls"  ~ "Lft T12",
    File ==  "/06_18_21/21618047.abf.xls"  ~ "Lft T12",
    File ==  "/06_18_21/21618052.abf.xls"  ~ "Lft T12",
    File ==  "/06_18_21/21618061.abf.xls"  ~ "Lft T12",
    File ==  "/06_17_21/21617018.abf.xls"  ~ "Rt L3",
    File ==  "/06_17_21/21617032.abf.xls"  ~ "Rt L5",
    File ==  "/06_17_21/21617036.abf.xls"  ~ "Rt L5",
    File ==  "/06_11_21/21611023.abf.xls" ~ "Lft T13",
    File ==  "/06_11_21/21611024.abf.xls" ~ "Lft T13",
    File ==  "/06_11_21/21611028.abf.xls" ~ "Lft T10",
    File ==  "/06_11_21/21611041.abf.xls" ~ "Lft L2",
    File ==  "/06_11_21/21611056.abf.xls" ~ "Lft L2",
    )) %>%
  mutate(StimLevelCode =  case_when(
    grepl("T6", StimLevel) == TRUE ~ 6,
    grepl("T7", StimLevel) == TRUE ~ 7,
    grepl("T8", StimLevel) == TRUE ~ 8,
    grepl("T9", StimLevel) == TRUE ~ 9,
    grepl("T10", StimLevel) == TRUE ~ 10,
    grepl("T11", StimLevel) == TRUE ~ 11,
    grepl("T12", StimLevel) == TRUE ~ 12,
    grepl("T13", StimLevel) == TRUE ~ 13,
    grepl("L1", StimLevel) == TRUE ~ 14,
    grepl("L2", StimLevel) == TRUE ~ 15,
    grepl("L3", StimLevel) == TRUE ~ 16,
    grepl("L4", StimLevel) == TRUE ~ 17,
    grepl("L5", StimLevel) == TRUE ~ 18,
    grepl("S1", StimLevel) == TRUE ~ 19)) %>%
  mutate(StimSideCode = case_when(
    grepl("Rt", StimLevel) ~ "R", 
    grepl("Lft", StimLevel) ~ "L")) 

histo$File <- substr(histo$File, 11,18)
histo <- histo %>%
  mutate(Day = substr(File, 1,5)) %>%
  mutate(Injury =  case_when(
    Day == 22131 ~ "SCI",
    Day == 22201 ~ "Sham",
    Day == 22203 ~ "SCI", 
    Day == 22324 ~ "SCI",
    Day  == 22602 ~ "SCI",
    Day  == 22606 ~ "SCI",
    Day  == 22608 ~ "Sham",
    Day == 21907 ~ "SCI",
    Day  == 21729 ~ "SCI",
    Day == 21727 ~ "Sham",
    Day == 21722 ~ "Sham",
    Day  == 21719 ~ "Sham",
    Day == 21716 ~ "SCI",
    Day  == 21708 ~ "Sham",
    Day  == 21625 ~ "SCI",
    Day == 21624 ~ "SCI",
    Day == 21618 ~ "Sham",
    Day == 21617 ~ "SCI",
    Day == 21611 ~ "SCI",
  ))  %>%
  mutate(ID  = case_when(
    Day == 21527 ~ "ML",
    Day == 21611 ~ "YL", #
    Day == 21617 ~ "PR", #
    Day == 21618 ~ "OR",
    Day == 21624 ~ "XR", #
    Day == 21625 ~ "NR", #
    Day == 21708 ~ "OL", #
    Day == 21716 ~ "PL", #
    Day == 21719 ~ "ZR",
    Day == 21722 ~ "ZL", #
    Day == 21727 ~ "AAR", #
    Day == 21729 ~ "XL", #
    Day == 21907 ~ "UU",
    Day == 22131 ~ "CCL",
    Day == 22201 ~ "VL", #
    Day == 22203 ~ "MR", #
    Day == 22324 ~ "Vg1A",
    Day  == 22602 ~ "Vg2A",
    Day  == 22606 ~ "Vg2B",
    Day  == 22608 ~ "Vg2C",
  )) %>%
  mutate(Week10VonFreyNorm  = case_when(
    ID ==  "YL" ~ 0.346229543,
    ID ==  "PR" ~ 0.512067404,
    ID ==  "OR" ~ 1.153156195,
    ID ==  "XR" ~ 0.170165373,
    ID ==  "NR" ~ 0.163995457,
    ID ==  "OL" ~ 0.822683424,
    ID ==  "PL" ~ 0.764670487,
    ID ==  "ZR" ~ 1,
    ID ==  "ZL" ~ 2.115467396,
    ID ==  "AAR" ~ 0.585625686,
    ID ==  "XL" ~ 0.731096184,
    ID ==  "CCL" ~ 0.393625581,
    ID == "UU" ~ 0, 
    ID ==  "VL" ~ 0,
    ID == "MR" ~ 0,
    ID == "Vg1A" ~ 0.639001421,
    ID == "Vg2A" ~ 0.815683801,
    ID == "Vg2B" ~ 1.494194832,
    ID == "Vg2C" ~ 0.838649142
  ))

histo1 <- na.omit(histo) %>%
  mutate(Distance = abs(StimLevelCode-LevelCode)) %>%
  mutate(Contralateral = case_when(
    RecSideCode  != StimSideCode ~ 1, 
    RecSideCode  == StimSideCode ~ 0)) %>%
  mutate(Volley = case_when(Stim_Num !=0 & Time_From_Stim  < 0.15  ~ 1, 
                            Stim_Num == 0 | Stim_Num !=0 & Time_From_Stim > 0.15 ~ 0))  %>%
  group_by(File, Channel, Stim_Num) %>%
  mutate(StimLatency =  case_when( 
    Stim_Num != 0 ~ (Burst_time - lag(Burst_time, default = first(Burst_time)))/10000,
    Stim_Num == 0 ~ 0)) %>%
  mutate(StimVolley = case_when(Stim_Num !=  0 & any(Volley == 1) == TRUE ~ 1, 
                                Stim_Num == 0 | Stim_Num != 0 & all(Volley == 0) == TRUE ~ 0)) %>%
  ungroup() %>%
  filter(Amplitude < 200) %>%
  filter(Rectified_Integrated > 0) %>%
  group_by(File, Channel) %>%
  ungroup() %>% 
  mutate(StimStrength = case_when(
    Stim_Num %% 3 == 1 ~ "50x50", 
    Stim_Num %% 3 == 2 ~ "200x200",
    Stim_Num != 0 & Stim_Num %% 3 == 0 ~ "500x500",
    Stim_Num == 0 ~ "Spontaneous")) 

library(xlsx)
write.xlsx(histo1, file  ="E:/Data/Cord_Prep_New//Collated_data.xlsx")


